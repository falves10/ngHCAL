# any line STARTING with '#' is a comment

# start each definition with <start_definition> and end with <end_definition>, each on it's own line
# every definition requires a name and type at minimum

# blocks must be declared AFTER name and type

# to fill a histogram, use the <fill> tag followed by the arguments to ->Fill()
      # example: <fill> (nTS, adc);

###########################################
<start_definition>
name = "General"
type = null

loop_vars = <start_block>
  int adcped = 3;
  float qped = adc2fC_QIE10_refl[ adcped ];
<end_block>

loop = <start_block>
  prevars.adcped = prevars.adcped;
  prevars.qped = prevars.qped;
  int tTS = digis.samples();
  tTS = tTS;
  int adc = digis[nTS].adc();
  adc = adc;
  int le_tdc = digis[nTS].le_tdc();
  le_tdc = le_tdc;
  int te_tdc = digis[nTS].te_tdc();
  te_tdc = te_tdc;
  int capid = digis[nTS].capid();
  capid = capid;
  int soi = digis[nTS].soi();
  soi = soi;
  float charge = adc2fC_QIE10_refl[ adc ] + 14.45;
  charge = charge;
  float acharge = charge - prevars.qped;
  acharge = acharge;
<end_block>

<end_definition>
###########################################
<start_suite>
name = "CapIDtesting"
code = 1
null = "General"
TH1F_perEV = "CapIDrot_EV" , "CapAllign_EV"
TH1F_perCH = "CapIDrot_CH" , "CapAllign_CH"
TH2F_perCH = "CIDvsTS_CH"
TH2F_perEV = "CIDvsTS_EV"
logger = "BadData_CH" , "ZeroData_CH"
<end_suite>
###########################################
<start_definition>
name = "CIDvsTS_CH"
type = TH2F_perCH
nbinsx = tTS
lowx = -0.5
highx = (float)tTS - (float)0.5
titlex = "TS"
nbinsy = 4
lowy = -0.5
highy = 3.5
titley = "CID"

loop_vars = <start_block>
  bool zero_event_CIDvsTS_CH;
<end_block>

pre_loop = <start_block>
  prevars.zero_event_CIDvsTS_CH = 0;
  for (int iTS=1 ; iTS<10 ; iTS++) { 
    if (digis[iTS].le_tdc() == 0) {
      prevars.zero_event_CIDvsTS_CH = 1;
    }
  }
<end_block>

loop = <start_block>
  if (prevars.zero_event_CIDvsTS_CH == 0) {
    <fill_perCH> ( nTS, capid );
  }
<end_block>

<end_definition>
##########################################
<start_definition>
name = "CIDvsTS_EV"
type = TH2F_perEV
nbinsx = tTS
lowx = -0.5
highx = (float)tTS - (float)0.5
titlex = "TS"
nbinsy = 4
lowy = -0.5
highy = 3.5
titley = "CID"

loop_vars = <start_block>
  bool zero_event_CIDvsTS_EV;
<end_block>

pre_loop = <start_block>
  prevars.zero_event_CIDvsTS_EV = 0;
  for (int iTS=1 ; iTS<10 ; iTS++) { 
    if (digis[iTS].le_tdc() == 0) {
      prevars.zero_event_CIDvsTS_EV = 1;
    }
  }
<end_block>

loop = <start_block>
  if (prevars.zero_event_CIDvsTS_EV == 0) {
    <fill_perEV> ( nTS, capid );
  }
<end_block>

<end_definition>
##########################################
<start_definition>
name = "CapIDrot_CH"
type = TH1F_perCH
nbinsx = 7
lowx = -3.5
highx = 3.5
titlex = "CID(N) - (CID(N-1)+1)%4"

loop_vars = <start_block>
  bool zero_event_CapIDrot_CH;
<end_block>

pre_loop = <start_block>
  prevars.zero_event_CapIDrot_CH = 0;
  for (int iTS=1 ; iTS<10 ; iTS++) { 
    if (digis[iTS].le_tdc() == 0) {
      prevars.zero_event_CapIDrot_CH = 1;
    }
  }
<end_block>

loop = <start_block>  
  if (nTS != 0) {
    if (prevars.zero_event_CapIDrot_CH == 0) {
      <fill_perCH> (capid - (digis[nTS-1].capid()+1)%4 );
    }
  }
<end_block>

<end_definition>
##########################################
<start_definition>
name = "CapIDrot_EV"
type = TH1F_perEV
nbinsx = 7
lowx = -3.5
highx = 3.5
titlex = "CID(N) - (CID(N-1)+1)%4"

loop_vars = <start_block>
  bool zero_event_CapIDrot_EV;
<end_block>

pre_loop = <start_block>
  prevars.zero_event_CapIDrot_EV = 0;
  for (int iTS=1 ; iTS<10 ; iTS++) { 
    if (digis[iTS].le_tdc() == 0) {
      prevars.zero_event_CapIDrot_EV = 1;
    }
  }
<end_block>

loop = <start_block>  
  if (nTS != 0) {
    if (prevars.zero_event_CapIDrot_EV == 0) {
      <fill_perEV> (capid - (digis[nTS-1].capid()+1)%4 );
    }
  }
<end_block>

<end_definition>
##########################################
<start_definition>
name = "CapAllign_CH"
type = TH1F_perCH
nbinsx = 7
lowx = -3.5
highx = 3.5
titlex = "CID - CID(ch0)"

loop_vars = <start_block>
  int* ch0_cid_ch = new int[10];
  bool zero_event_CapAllign_CH;
<end_block>

pre_loop = <start_block>
  prevars.zero_event_CapAllign_CH = 0;
  for (int iTS=1 ; iTS<10 ; iTS++) { 
    if (digis[iTS].le_tdc() == 0) {
      prevars.zero_event_CapAllign_CH = 1;
    }
  }
<end_block>


loop = <start_block>   
  if (nCH == 0) {
    prevars.ch0_cid_ch[nTS] = digis[nTS].capid();
  }
  if (prevars.zero_event_CapAllign_CH == 0) {
    <fill_perCH> (capid - prevars.ch0_cid_ch[nTS]);
  }
<end_block>

<end_definition>
##########################################
<start_definition>
name = "CapAllign_EV"
type = TH1F_perEV
nbinsx = 7
lowx = -3.5
highx = 3.5
titlex = "CID - CID(ch0)"

loop_vars = <start_block>
  int* ch0_cid_ev = new int[10];
  bool zero_event_CapAllign_EV;
<end_block>

pre_loop = <start_block>
  prevars.zero_event_CapAllign_EV = 0;
  for (int iTS=1 ; iTS<10 ; iTS++) { 
    if (digis[iTS].le_tdc() == 0) {
      prevars.zero_event_CapAllign_EV = 1;
    }
  }
<end_block>


loop = <start_block>   
  if (nCH == 0) {
    prevars.ch0_cid_ev[nTS] = digis[nTS].capid();
  }
  if (prevars.zero_event_CapAllign_EV == 0) {
    <fill_perEV> (capid - prevars.ch0_cid_ev[nTS]);
  }
<end_block>

<end_definition>
##########################################
<start_definition>
name = "BadData_CH"
type = logger
log_file = "../log/bad_data.log"

loop_vars = <start_block>
  bool bad_flag;
<end_block>

pre_loop = <start_block>
  DetId detid_loc = digis.detid();
  HcalDetId hcaldetid_loc = HcalDetId(detid_loc);
  int iEta_loc = hcaldetid_loc.ieta();
  int iPhi_loc = hcaldetid_loc.iphi();
  int Depth_loc = hcaldetid_loc.depth();

  prevars.bad_flag = 0;
  bool zero_event_flag = 0;
  for (int iTS=1 ; iTS<10 ; iTS++) { 
    if ( (digis[iTS].capid() - (digis[iTS-1].capid()+1)%4) != 0 ) {
      prevars.bad_flag = 1;
    }
    if (digis[iTS].le_tdc() == 0) {
      zero_event_flag = 1;
    }
  }
  if (zero_event_flag == 1){
    prevars.bad_flag = 0;
  }
  if (prevars.bad_flag == 1) {
     <log> "#############" << endl;
     <log> "# BAD EVENT" << endl;
     <log> "# HF: " << Depth_loc << endl;
     <log> "# Slot: " << iPhi_loc << endl;
     <log> "# QIE: " << iEta_loc << endl;
     <log> "# nEV:" << _event_num << endl;
     <log> "#############" << endl;
    for (int iTS=0 ; iTS<10 ; iTS++) {
      if (( (digis[iTS].capid() - (digis[iTS-1].capid()+1)%4) != 0 ) && ( iTS != 0 )) {
         <log> "TS:" << iTS << "  --  CID " << digis[iTS].capid() << "  --  ADC " << digis[iTS].adc() << "  --  leTDC " << digis[iTS].le_tdc() << "  --  teTDC " << digis[iTS].te_tdc() << "  <<<<<<<<" << endl;
      }
      else {
         <log> "TS:" << iTS << "  --  CID " << digis[iTS].capid() << "  --  ADC " << digis[iTS].adc() << "  --  leTDC " << digis[iTS].le_tdc() << "  --  teTDC " << digis[iTS].te_tdc() << endl;
      }
    }
     <log> "#############" << endl;
  }
<end_block>

<end_definition>
##########################################
<start_definition>
name = "ZeroData_CH"
type = logger
log_file = "../log/zero_data.log"

pre_loop = <start_block>
  DetId detid_loc_z = digis.detid();
  HcalDetId hcaldetid_loc_z = HcalDetId(detid_loc_z);
  int iEta_loc_z = hcaldetid_loc_z.ieta();
  int iPhi_loc_z = hcaldetid_loc_z.iphi();
  int Depth_loc_z = hcaldetid_loc_z.depth();

  bool zero_event_flag_z = 0;
  for (int iTS=1 ; iTS<10 ; iTS++) { 
    if (digis[iTS].le_tdc() == 0) {
      zero_event_flag_z = 1;
    }
  }
  if (zero_event_flag_z == 1) {
     <log> "#############" << endl;
     <log> "# BAD EVENT" << endl;
     <log> "# HF: " << Depth_loc_z << endl;
     <log> "# Slot: " << iPhi_loc_z << endl;
     <log> "# QIE: " << iEta_loc_z << endl;
     <log> "# nEV:" << _event_num << endl;
     <log> "#############" << endl;
     for (int iTS=0 ; iTS<10 ; iTS++) {
        <log> "TS:" << iTS << "  --  CID " << digis[iTS].capid() << "  --  ADC " << digis[iTS].adc() << "  --  leTDC " << digis[iTS].le_tdc() << "  --  teTDC " << digis[iTS].te_tdc() << endl;
     }
     <log> "#############" << endl;
  }
<end_block>

<end_definition>
##########################################
<start_suite>
name = "PedestalData"
code = 2
null = "General"
TH1F_perEV = "QSum_ped_EV" , "ADC_ped_EV" , "Qav_ped_EV"
TH1F_perCH = "QSum_ped_CH" , "ADC_ped_CH"
TH2F_perEV = "ADCvsTS_ped_EV" , "Qav_ped_CID" , "ADC_ped_CID"
TH2F_perCH = "ADCvsTS_ped_CH" 
<end_suite>
###########################################
<start_definition>
name = "ADC_ped_EV"
type = TH1F_perEV
nbinsx = 25
lowx = -0.5
highx = 24.5
titlex = "ADC"

loop = <start_block>
  <fill_perEV> ( adc );
<end_block>

<end_definition>
###########################################
<start_definition>
name = "ADC_ped_CH"
type = TH1F_perCH
nbinsx = 25
lowx = -0.5
highx = 24.5
titlex = "ADC"

loop = <start_block>
  <fill_perCH> ( adc );
<end_block>

<end_definition>
###########################################
<start_definition>
name = "ADCvsTS_ped_CH"
type = TH2F_perCH
nbinsx = tTS
lowx = -0.5
highx = (float)tTS - (float)0.5
titlex = "TS"
nbinsy = 256
lowy = -0.5
highy = 255.5
titley = "ADC"

loop = <start_block>
  <fill_perCH> ( nTS, adc );
<end_block>

<end_definition>
##########################################
<start_definition>
name = "ADCvsTS_ped_EV"
type = TH2F_perEV
nbinsx = tTS
lowx = -0.5
highx = (float)tTS - (float)0.5
titlex = "TS"
nbinsy = 256
lowy = -0.5
highy = 255.5
titley = "ADC"

loop = <start_block>
  <fill_perEV> ( nTS, adc );
<end_block>

<end_definition>
##########################################
<start_definition>
name = "QSum_ped_EV"
type = TH1F_perEV
nbinsx = 50
lowx = 0
highx = 500
titlex = "Integrated Charge (fC)"

loop_vars = <start_block>
  float qsum_ped_EV;
<end_block>

pre_loop = <start_block>
  prevars.qsum_ped_EV = 0;
<end_block>

loop = <start_block>
  prevars.qsum_ped_EV += (charge - prevars.qped);
<end_block>

post_loop = <start_block>
  <fill_perEV> ( prevars.qsum_ped_EV );
<end_block>

<end_definition>
##########################################
<start_definition>
name = "QSum_ped_CH"
type = TH1F_perCH
nbinsx = 50
lowx = 0
highx = 500
titlex = "Integrated Charge (fC)"

loop_vars = <start_block>
  float qsum_ped_CH;
<end_block>

pre_loop = <start_block>
  prevars.qsum_ped_CH = 0;
<end_block>

loop = <start_block>
  prevars.qsum_ped_CH += (charge - prevars.qped);
<end_block>

post_loop = <start_block>
  <fill_perCH> ( prevars.qsum_ped_CH );
<end_block>

<end_definition>
##########################################
<start_definition>
name = "Qav_ped_EV"
type = TH1F_perEV
nbinsx = 50
lowx = 0
highx = 50
titlex = "Q (fC)"

loop_vars = <start_block>
  float qav_ped_EV;
<end_block>

pre_loop = <start_block>
  prevars.qav_ped_EV = 0;
<end_block>

loop = <start_block>
  prevars.qav_ped_EV += (charge - prevars.qped);
<end_block>

post_loop = <start_block>
  <fill_perEV> ( prevars.qsum_ped_EV / float(digis.samples()) );
<end_block>

<end_definition>
###########################################
<start_definition>
name = "Qav_ped_CID"
type = TH2F_perEV
nbinsx = 4
lowx = -0.5
highx = 3.5
titlex = "CID"
nbinsy = 50
lowy = 0
highy = 15
titley = "Q (fC)"

loop_vars = <start_block>
  float* qav_ped_CID = new float[4];
  int* cid_count  = new int[4];
<end_block>

pre_loop = <start_block>
  for (int jj=0 ; jj < 4; jj++){
    prevars.qav_ped_CID[jj] = 0;
    prevars.cid_count[jj] = 0;	
  }   
<end_block>

loop = <start_block>
  prevars.qav_ped_CID[capid] += (charge - prevars.qped);
  prevars.cid_count[capid] += 1;
<end_block>

post_loop = <start_block>
  for (int jj=0 ; jj < 4; jj++){
    <fill_perEV> ( jj , (prevars.qav_ped_CID[jj] / prevars.cid_count[jj]) );
  }   
<end_block>

<end_definition>
###########################################
<start_definition>
name = "ADC_ped_CID"
type = TH2F_perEV
nbinsx = 4
lowx = -0.5
highx = 3.5
titlex = "CID"
nbinsy = 25
lowy = 0
highy = 50
titley = "ADC"

loop = <start_block>
  <fill_perEV> ( capid , adc );
<end_block>

<end_definition>
###########################################
<start_suite>
name = "AbsoluteTiming"
code = 3
null = "General"
TH1F_perEV = "T_abs_EV"
TH1F_perCH = "T_abs_CH"
TH2F_perEV = "QvsTS_EV" , "TDCvsTS_EV"
TH2F_perCH = "QvsTS_CH" , "TDCvsTS_CH"
<end_suite>
###########################################
<start_definition>
name = "T_abs_EV"
type = TH1F_perEV
nbinsx = 250
lowx = -0.5
highx = 249.5
titlex = "t (ns)"

loop_vars = <start_block>
  bool first_tdc_EV;
<end_block>

pre_loop = <start_block>
  prevars.first_tdc_EV = 1;
<end_block>

loop = <start_block>
  if ((prevars.first_tdc_EV == 1) && (le_tdc < 50)) {
    prevars.first_tdc_EV = 0;
    float t_abs = ((nTS-1)*25.0) + (le_tdc*0.5);
    <fill_perEV> (t_abs);
  }
<end_block>

<end_definition>
###########################################
<start_definition>
name = "T_abs_CH"
type = TH1F_perCH
nbinsx = 250
lowx = -0.5
highx = 249.5
titlex = "t (ns)"

loop_vars = <start_block>
  bool first_tdc_CH;
<end_block>

pre_loop = <start_block>
  prevars.first_tdc_CH = 1;
<end_block>

loop = <start_block>
  if ((prevars.first_tdc_CH == 1) && (le_tdc < 50)) {
    prevars.first_tdc_CH = 0;
    float t_abs = (nTS*25.0) + (le_tdc*0.5);
    <fill_perCH> (t_abs);
  }
<end_block>

<end_definition>
###########################################
<start_definition>
name = "TDCvsTS_CH"
type = TH2F_perCH
nbinsx = tTS
lowx = -0.5
highx = (float)tTS - (float)0.5
titlex = "TS"
nbinsy = 50
lowy = -0.5
highy = 49.5
titley = "TDC (0.5 ns)"

loop = <start_block>
  <fill_perCH> ( nTS, le_tdc );
<end_block>

<end_definition>
##########################################
<start_definition>
name = "TDCvsTS_EV"
type = TH2F_perEV
nbinsx = tTS
lowx = -0.5
highx = (float)tTS - (float)0.5
titlex = "TS"
nbinsy = 50
lowy = -0.5
highy = 49.5
titley = "TDC (0.5 ns)"

loop = <start_block>
  <fill_perEV> ( nTS, le_tdc );
<end_block>

<end_definition>
##########################################
<start_suite>
name = "PedScanner"
code = 4
null = "General"
TH1F_perCH = "DefaultPed_CH"
TH1F_perEV = "DefaultPed_EV"
TH2F_perCH = "ADCvsEV_CH" , "PedScan_CH" , "PedScan_q_CH" , "PedScan_qav_CH"
TH2F_perEV = "ADCvsEV_EV" , "PedScan_EV"
<end_suite>
###########################################
<start_definition>
name = "DefaultPed_CH"
type = TH1F_perCH
nbinsx = 25
lowx = -0.5
highx = 24.5
titlex = "ADC"

loop = <start_block>
  if ( val == 38.0 ) {
    <fill_perCH> ( adc );
  }
<end_block>

<end_definition>
###########################################
<start_definition>
name = "DefaultPed_EV"
type = TH1F_perEV
nbinsx = 25
lowx = -0.5
highx = 24.5
titlex = "ADC"

loop = <start_block>
  if ( val == 38.0 ) {
    <fill_perEV> ( adc );
  }
<end_block>

<end_definition>
###########################################
<start_definition>
name = "ADCvsEV_CH"
type = TH2F_perCH
nbinsx = 3300
lowx = -0.5
highx = 3299.5
titlex = "nEV"
nbinsy = 256
lowy = -0.5
highy = 255.5
titley = "avADC"

pre_loop = <start_block>
  int tTS = digis.samples();
  int ADCsum = 0;
  for (int loopTS=0 ; loopTS < tTS ; loopTS++) {
    ADCsum += digis[loopTS].adc();
  }
  float avADC = (float)ADCsum / (float)tTS;
  if (_event_num < 3300) {
    <fill_perCH> ( _event_num, avADC );
  }
<end_block>

<end_definition>
##########################################
<start_definition>
name = "ADCvsEV_EV"
type = TH2F_perEV
nbinsx = 3300
lowx = -0.5
highx = 3299.5
titlex = "nEV"
nbinsy = 256
lowy = -0.5
highy = 255.5
titley = "avADC"

pre_loop = <start_block>
  int tTS_EV = digis.samples();
  int ADCsum_EV = 0;
  for (int loopTS=0 ; loopTS < tTS_EV ; loopTS++) {
    ADCsum_EV += digis[loopTS].adc();
  }
  float avADC_EV = (float)ADCsum_EV / (float)tTS_EV;
  if (_event_num < 3300) {
    <fill_perEV> ( _event_num, avADC_EV );
  }
<end_block>

<end_definition>
##########################################
<start_definition>
name = "PedScan_EV"
type = TH2F_perEV
nbinsx = 64
lowx = -0.5
highx = 63.5
titlex = "PedestalDAC"
nbinsy = 64
lowy = -0.5
highy = 63.5
titley = "avADC"

pre_loop = <start_block>
  int tTS_scan_EV = digis.samples();
  int ADCsum_scan_EV = 0;
  for (int loopTS=0 ; loopTS < tTS_scan_EV ; loopTS++) {
    ADCsum_scan_EV += digis[loopTS].adc();
  }
  float avADC_scan_EV = (float)ADCsum_scan_EV / (float)tTS_scan_EV;
  <fill_perEV> ( val , avADC_scan_EV );
<end_block>

<end_definition>
##########################################
<start_definition>
name = "PedScan_CH"
type = TH2F_perCH
nbinsx = 64
lowx = -0.5
highx = 63.5
titlex = "PedestalDAC"
nbinsy = 64
lowy = -0.5
highy = 63.5
titley = "avADC"

pre_loop = <start_block>
  int tTS_scan_CH = digis.samples();
  int ADCsum_scan_CH = 0;
  for (int loopTS=0 ; loopTS < tTS_scan_CH ; loopTS++) {
    ADCsum_scan_CH += digis[loopTS].adc();
  }
  float avADC_scan_CH = (float)ADCsum_scan_CH / (float)tTS_scan_CH;
  <fill_perCH> ( val , avADC_scan_CH );
<end_block>

<end_definition>
##########################################
<start_definition>
name = "PedScan_q_CH"
type = TH2F_perCH
nbinsx = 64
lowx = -0.5
highx = 63.5
titlex = "PedestalDAC"
nbinsy = 75
lowy = -0.5
highy = 74.5
titley = "Charge (fC)"

loop = <start_block>
  <fill_perCH> ( val , charge);
<end_block>

<end_definition>
##########################################
<start_definition>
name = "PedScan_qav_CH"
type = TH2F_perCH
nbinsx = 64
lowx = -0.5
highx = 63.5
titlex = "PedestalDAC"
nbinsy = 75
lowy = -0.5
highy = 74.5
titley = "Charge (fC)"

pre_loop = <start_block>
  int tTS_scan_qav_CH = digis.samples();
  int qsum_scan_CH = 0;
  for (int loopTS=0 ; loopTS < tTS_scan_qav_CH ; loopTS++) {
    qsum_scan_CH += adc2fC_QIE10_refl[ digis[loopTS].adc() ] + 14.45;
  }
  float qav_scan_CH = (float)qsum_scan_CH / (float)tTS_scan_qav_CH;
  <fill_perCH> ( val , qav_scan_CH );
<end_block>

<end_definition>
##########################################
<start_suite>
name = "PhaseScanner"
code = 5
null = "General"
TH2F_perCH = "phase_scan_CH"
TH2F_perEV = "phase_scan_EV"
<end_suite>
###########################################
<start_definition>
name = "phase_scan_EV"
type = TH2F_perEV
nbinsx = 100
lowx = -0.25
highx = 49.75
titlex = "phase (ns)"
nbinsy = 250
lowy = -0.5
highy = 249.5
titley = "TDC (ns)"

loop_vars = <start_block>
  bool first_tdc_scan_EV;
<end_block>

pre_loop = <start_block>
  prevars.first_tdc_scan_EV = 1;
<end_block>

loop = <start_block>
  if ((prevars.first_tdc_scan_EV == 1) && (le_tdc < 50)) {
    prevars.first_tdc_scan_EV = 0;
    float t_abs = ((nTS-1)*25.0) + (le_tdc*0.5);
    if ( val < 50 ) {
       <fill_perEV> (val/2.0,t_abs);
    }
    if ( val > 63 ) {
       <fill_perEV> ((val-14.0)/2.0,t_abs);
    }
  }
<end_block>

<end_definition>
###########################################
<start_definition>
name = "phase_scan_CH"
type = TH2F_perCH
nbinsx = 100
lowx = -0.25
highx = 49.75
titlex = "phase (ns)"
nbinsy = 250
lowy = -0.5
highy = 249.5
titley = "TDC (ns)"

loop_vars = <start_block>
  bool first_tdc_scan_CH;
<end_block>

pre_loop = <start_block>
  prevars.first_tdc_scan_CH = 1;
<end_block>

loop = <start_block>
  if ((prevars.first_tdc_scan_CH == 1) && (le_tdc < 50)) {
    prevars.first_tdc_scan_CH = 0;
    float t_abs = ((nTS-1)*25.0) + (le_tdc*0.5);
    if ( val < 50 ) {
       <fill_perCH> (val/2.0,t_abs);
    }
    if ( val > 63 ) {
       <fill_perCH> ((val-14.0)/2.0,t_abs);
    }
  }
<end_block>

<end_definition>
###########################################
<start_suite>
name = "ICIScanner"
code = 6
null = "General"
TH1F_perCH = "T_abs_CH" , "qratio_CH" , "ICI7_CH"
TH1F_perEV = "T_abs_EV" , "qratio_EV" , "ICI7_EV"
TH2F_perCH = "ici_scan_CH" , "qratio2_CH" , "pulse_ICI7_CH"
TH2F_perEV = "ici_scan_EV" , "qratio2_EV"
<end_suite>
###########################################
<start_definition>
name = "ici_scan_CH"
type = TH2F_perCH
nbinsx = 200
lowx = 0
highx = 10000
titlex = "ICI setting"
nbinsy = 200
lowy = 0
highy = 10000
titley = "ADC"

loop_vars = <start_block>
  float ici_ch[8] = {90, 180, 360, 720, 1440, 2880, 5760, 8640}; 
  float qsum_ici_ch;
<end_block>

pre_loop = <start_block>
  prevars.qsum_ici_ch = 0.0;
<end_block>

loop = <start_block>
  prevars.qsum_ici_ch += charge;
<end_block>

post_loop = <start_block>
  if (val < 8 ) {
    <fill_perCH> ( prevars.ici_ch[(int)val] , prevars.qsum_ici_ch );
  }
<end_block>

<end_definition>
###########################################
<start_definition>
name = "ici_scan_EV"
type = TH2F_perEV
nbinsx = 200
lowx = 0
highx = 10000
titlex = "ICI setting"
nbinsy = 200
lowy = 0
highy = 10000
titley = "ADC"

loop_vars = <start_block>
  float ici_ev[8] = {90, 180, 360, 720, 1440, 2880, 5760, 8640}; 
  float qsum_ici_ev;
<end_block>

pre_loop = <start_block>
  prevars.qsum_ici_ev = 0.0;
<end_block>

loop = <start_block>
  prevars.qsum_ici_ev += charge;
<end_block>

post_loop = <start_block>
  if (val < 8 ) {
    <fill_perEV> ( prevars.ici_ev[(int)val] , prevars.qsum_ici_ev );
  }
<end_block>

<end_definition>
###########################################
<start_definition>
name = "qratio_CH"
type = TH1F_perCH
nbinsx = 100
lowx = 0
highx = 1
titlex = "Ratio Qmax/Qsum"

loop_vars = <start_block>
  float qsum_qr_ch;
  float qmax_qr_ch;
<end_block>

pre_loop = <start_block>
  prevars.qsum_qr_ch = 0.0;
  prevars.qmax_qr_ch = 0.0;
<end_block>

loop = <start_block>
  prevars.qsum_qr_ch += charge;
  if ( charge > prevars.qmax_qr_ch ) {
    prevars.qmax_qr_ch = charge;
  }
<end_block>

post_loop = <start_block>
  <fill_perCH> ( prevars.qmax_qr_ch / prevars.qsum_qr_ch );
<end_block>

<end_definition>
###########################################
<start_definition>
name = "qratio_EV"
type = TH1F_perEV
nbinsx = 100
lowx = 0
highx = 1
titlex = "Ratio Qmax/Qsum"

loop_vars = <start_block>
  float qsum_qr_ev;
  float qmax_qr_ev;
<end_block>

pre_loop = <start_block>
  prevars.qsum_qr_ev = 0.0;
  prevars.qmax_qr_ev = 0.0;
<end_block>

loop = <start_block>
  prevars.qsum_qr_ev += charge;
  if ( charge > prevars.qmax_qr_ev ) {
    prevars.qmax_qr_ev = charge;
  }
<end_block>

post_loop = <start_block>
  <fill_perEV> ( prevars.qmax_qr_ev / prevars.qsum_qr_ev );
<end_block>

<end_definition>
###########################################
<start_definition>
name = "qratio2_CH"
type = TH2F_perCH
nbinsx = 8
lowx = -0.5
highx = 7.5
titlex = "ICI setting"
nbinsy = 100
lowy = 0
highy = 1
titley = "Ratio Qmax/Qsum"

loop_vars = <start_block>
  float qsum_qr2_ch;
  float qmax_qr2_ch;
<end_block>

pre_loop = <start_block>
  prevars.qsum_qr2_ch = 0.0;
  prevars.qmax_qr2_ch = 0.0;
<end_block>

loop = <start_block>
  prevars.qsum_qr2_ch += charge;
  if ( charge > prevars.qmax_qr2_ch ) {
    prevars.qmax_qr2_ch = charge;
  }
<end_block>

post_loop = <start_block>
  <fill_perCH> ( val , prevars.qmax_qr2_ch / prevars.qsum_qr2_ch );
<end_block>

<end_definition>
###########################################
<start_definition>
name = "qratio2_EV"
type = TH2F_perEV
nbinsx = 8
lowx = -0.5
highx = 7.5
titlex = "ICI setting"
nbinsy = 100
lowy = 0
highy = 1
titley = "Ratio Qmax/Qsum"

loop_vars = <start_block>
  float qsum_qr2_ev;
  float qmax_qr2_ev;
<end_block>

pre_loop = <start_block>
  prevars.qsum_qr2_ev = 0.0;
  prevars.qmax_qr2_ev = 0.0;
<end_block>

loop = <start_block>
  prevars.qsum_qr2_ev += charge;
  if ( charge > prevars.qmax_qr2_ev ) {
    prevars.qmax_qr2_ev = charge;
  }
<end_block>

post_loop = <start_block>
  <fill_perEV> ( val , prevars.qmax_qr2_ev / prevars.qsum_qr2_ev );
<end_block>

<end_definition>
###########################################
<start_definition>
name = "ICI7_CH"
type = TH1F_perCH
nbinsx = 100
lowx = 0
highx = 1
titlex = "Ratio Qmax/Qsum"

loop_vars = <start_block>
  float qsum_ici7_ch;
  float qmax_ici7_ch;
<end_block>

pre_loop = <start_block>
  prevars.qsum_ici7_ch = 0;
  prevars.qmax_ici7_ch = 0;
<end_block>

loop = <start_block>
  prevars.qsum_ici7_ch += charge;
  if (charge > prevars.qmax_ici7_ch ) {
    prevars.qmax_ici7_ch = charge;
  }
<end_block>

post_loop = <start_block>
  if ( val == 7 ) {
    <fill_perCH> ( prevars.qmax_ici7_ch / prevars.qsum_ici7_ch );
  }
<end_block>

<end_definition>
###########################################
<start_definition>
name = "ICI7_EV"
type = TH1F_perEV
nbinsx = 100
lowx = 0
highx = 1
titlex = "Ratio Qmax/Qsum"

loop_vars = <start_block>
  float qsum_ici7_ev;
  float qmax_ici7_ev;
<end_block>

pre_loop = <start_block>
  prevars.qsum_ici7_ev = 0;
  prevars.qmax_ici7_ev = 0;
<end_block>

loop = <start_block>
  prevars.qsum_ici7_ev += charge;
  if (charge > prevars.qmax_ici7_ev ) {
    prevars.qmax_ici7_ev = charge;
  }
<end_block>

loop = <start_block>
  if ( val == 7 ) {
    <fill_perEV> ( prevars.qmax_ici7_ev / prevars.qsum_ici7_ev );
  }
<end_block>

<end_definition>
###########################################
<start_definition>
name = "pulse_ICI7_CH"
type = TH2F_perCH
nbinsx = 10
lowx = -0.5
highx = 9.5
titlex = "TS"
nbinsy = 256
lowy = 0
highy = 10000
titley = "Q (fC)"

loop = <start_block>
  if ( val == 7 ) {
    <fill_perCH> ( nTS, charge );
  }
<end_block>

<end_definition>
###########################################
